<!DOCTYPE html>
<html>
<head>
    <title>Directions with Current Location</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
    <style>
        #map { height: 500px; width: 100%; }
    </style>
</head>
<body>

<h2>Directions Map</h2>
<input type="text" id="destination" placeholder="Enter destination e.g. Rajshahi New Market"/>
<button onclick="showRoute()">Get Directions</button>
<p id="status">Enter destination and click button.</p>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
const status = document.getElementById("status");
const map = L.map('map').setView([23.8103, 90.4125], 7); // default Bangladesh

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
}).addTo(map);

let routingControl;
let currentMarker;

// Function to geocode destination
async function geocode(address) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
        const data = await res.json();
        if (data.length === 0) throw "Address not found";
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    } catch(err) {
        console.error(err);
        return null;
    }
}

// Function to get current location and plot route
function showRoute() {
    const destinationInput = document.getElementById("destination").value;
    if (!destinationInput) {
        alert("Please enter a destination");
        return;
    }

    if (!navigator.geolocation) {
        status.textContent = "Geolocation not supported";
        return;
    }

    status.textContent = "Locatingâ€¦";

    navigator.geolocation.getCurrentPosition(async (position) => {
        const origin = [position.coords.latitude, position.coords.longitude];
        const destination = await geocode(destinationInput);

        if (!destination) {
            status.textContent = "Destination not found";
            return;
        }

        status.textContent = `Routing from your location to ${destinationInput}`;

        // Add current location marker
        if (currentMarker) map.removeLayer(currentMarker);
        currentMarker = L.marker(origin).addTo(map)
            .bindPopup("You are here")
            .openPopup();

        // Remove previous route
        if (routingControl) map.removeControl(routingControl);

        // Add route
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(origin[0], origin[1]),
                L.latLng(destination[0], destination[1])
            ],
            routeWhileDragging: false,
            geocoder: L.Control.Geocoder.nominatim()
        }).addTo(map);

        // Fit map to route bounds after routing is ready
        routingControl.on('routesfound', function(e) {
            const bounds = e.routes[0].bounds;
            map.fitBounds(bounds);
        });

    }, (err) => {
        status.textContent = "Error getting location: " + err.message;
    });
}
</script>

</body>
</html>
